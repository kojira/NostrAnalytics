# 独自kind仕様書

## kind: 30080 - Language-based Active User Analytics

### 概要

Nostr上の言語別アクティブユーザー分析結果を保存・共有するためのParameterized Replaceable Event（NIP-33）です。

### 基本情報

- **kind**: 30080
- **種別**: Parameterized Replaceable Event (NIP-33)
- **目的**: 言語別のDAU/WAU/MAU/YAU等のメトリクスを時系列データとして保存

### イベント構造

#### Tags

| Tag | 必須 | 説明 | 例 |
|-----|------|------|-----|
| `d` | ✓ | イベント識別子（パラメータ化置換用）| `dau-ja-day-1-1704067200-1711929600-v1` |
| `l` | ✓ | 対象言語（ISO 639-1） | `ja` |
| `r` | ✓ | 分析対象リレー（複数可） | `wss://relay.damus.io` |
| `algo` | ✓ | アルゴリズム情報 | `lang=whatlang@0.16;act=all-kinds;elig=lifetime` |
| `gran` | ✓ | 粒度 | `day` |
| `wdays` | ✓ | ウィンドウ日数 | `1`, `7`, `30`, `365` |
| `app` | ✓ | 生成アプリケーション | `nostr-analytics/0.1.0` |

#### d tag フォーマット

```
<metric>-<lang>-<gran>-<window_days>-<range_start>-<range_end>-<algo_version>
```

**例**:
- `dau-ja-day-1-1704067200-1711929600-v1`
- `mau-en-day-30-1704067200-1711929600-v1`

**要素**:
- `metric`: `dau`, `wau`, `mau`, `yau`
- `lang`: ISO 639-1言語コード
- `gran`: `day`（現在は日次のみ）
- `window_days`: `1`, `7`, `30`, `365`
- `range_start`: 分析期間開始（Unix timestamp）
- `range_end`: 分析期間終了（Unix timestamp）
- `algo_version`: アルゴリズムバージョン（`v1`）

#### algo tag フォーマット

```
lang=<detector>@<version>;act=<activity_kinds>;elig=<eligibility_rule>
```

**例**:
```
lang=whatlang@0.16;act=all-kinds;elig=lifetime
```

**要素**:
- `lang`: 言語検出器とバージョン
- `act`: アクティビティ判定対象（`all-kinds`, `kind-1`, `kind-1-6-7`等）
- `elig`: 対象ユーザー判定ルール（`lifetime`, `period`等）

### Content (JSON)

```json
{
  "version": 1,
  "metric": "dau|wau|mau|yau",
  "language": "ja",
  "relays": [
    "wss://relay.damus.io",
    "wss://nos.lol"
  ],
  "timeframe": {
    "start": 1704067200,
    "end": 1711929600,
    "granularity": "day",
    "windowDays": 1
  },
  "counts": [
    [19723, 450],
    [19724, 478],
    [19725, 502]
  ],
  "eligibleUserCount": 15000,
  "notes": "Generated by Nostr Analytics at 2024-01-15T10:30:00Z"
}
```

#### フィールド説明

| フィールド | 型 | 説明 |
|-----------|-----|------|
| `version` | number | スキーマバージョン（現在は `1`） |
| `metric` | string | メトリクス種別（`dau`, `wau`, `mau`, `yau`） |
| `language` | string | 対象言語（ISO 639-1） |
| `relays` | string[] | 分析対象リレーURL配列 |
| `timeframe.start` | number | 分析期間開始（Unix timestamp） |
| `timeframe.end` | number | 分析期間終了（Unix timestamp） |
| `timeframe.granularity` | string | データ粒度（`day`） |
| `timeframe.windowDays` | number | スライディングウィンドウ日数 |
| `counts` | [number, number][] | `[epochDay, count]`の配列 |
| `eligibleUserCount` | number | 対象ユーザー総数（U_lang） |
| `notes` | string | 任意のメモ・メタデータ |

#### counts配列

各要素は `[epochDay, count]` の形式：

- `epochDay`: Unix epoch（1970-01-01 00:00:00 UTC）からの日数
- `count`: その日のアクティブユーザー数

**例**:
```json
[19723, 450]  // 2024-01-01: 450人
```

**epochDayの計算**:
```
epochDay = floor(unixTimestamp / 86400)
```

### 使用例

#### DAU（日次アクティブユーザー）

```json
{
  "kind": 30080,
  "created_at": 1704110400,
  "tags": [
    ["d", "dau-ja-day-1-1704067200-1711929600-v1"],
    ["l", "ja"],
    ["r", "wss://relay.damus.io"],
    ["r", "wss://nos.lol"],
    ["algo", "lang=whatlang@0.16;act=all-kinds;elig=lifetime"],
    ["gran", "day"],
    ["wdays", "1"],
    ["app", "nostr-analytics/0.1.0"]
  ],
  "content": "{\"version\":1,\"metric\":\"dau\",\"language\":\"ja\",\"relays\":[\"wss://relay.damus.io\",\"wss://nos.lol\"],\"timeframe\":{\"start\":1704067200,\"end\":1711929600,\"granularity\":\"day\",\"windowDays\":1},\"counts\":[[19723,450],[19724,478],[19725,502]],\"eligibleUserCount\":15000,\"notes\":\"Generated by Nostr Analytics at 2024-01-15T10:30:00Z\"}"
}
```

#### MAU（月次アクティブユーザー）

```json
{
  "kind": 30080,
  "created_at": 1704110400,
  "tags": [
    ["d", "mau-en-day-30-1704067200-1711929600-v1"],
    ["l", "en"],
    ["r", "wss://relay.damus.io"],
    ["algo", "lang=whatlang@0.16;act=all-kinds;elig=lifetime"],
    ["gran", "day"],
    ["wdays", "30"],
    ["app", "nostr-analytics/0.1.0"]
  ],
  "content": "{\"version\":1,\"metric\":\"mau\",\"language\":\"en\",\"relays\":[\"wss://relay.damus.io\"],\"timeframe\":{\"start\":1704067200,\"end\":1711929600,\"granularity\":\"day\",\"windowDays\":30},\"counts\":[[19723,8500],[19724,8520]],\"eligibleUserCount\":50000,\"notes\":\"Generated by Nostr Analytics\"}"
}
```

### クエリ方法

#### 特定言語のDAUを取得

```json
{
  "kinds": [30080],
  "#l": ["ja"],
  "#wdays": ["1"]
}
```

#### 特定リレーの分析結果を取得

```json
{
  "kinds": [30080],
  "#r": ["wss://relay.damus.io"]
}
```

#### 特定期間のMAUを取得

```json
{
  "kinds": [30080],
  "#l": ["en"],
  "#wdays": ["30"],
  "since": 1704067200,
  "until": 1711929600
}
```

### バージョニング

#### v1 (現在)

- 初期仕様
- 日次粒度のみ
- 全kindアクティビティ対象
- whatlangベースの言語検出

#### 将来のバージョン（予定）

- v2: 時間単位粒度のサポート
- v3: kind別フィルタリング
- v4: 複数言語検出器のサポート

### 互換性

- **置換ルール**: 同じ`d`タグを持つイベントは最新のものに置換される（NIP-33）
- **後方互換性**: `version`フィールドで識別
- **拡張性**: `content`のJSONに新フィールド追加可能

### セキュリティ考慮事項

- イベントはNIP-07で署名される
- 分析結果は公開情報（個人特定不可）
- pubkeyは含まれない（集計値のみ）

### 実装ノート

1. **重複回避**: 同じパラメータでの再発行は`d`タグで自動置換
2. **データサイズ**: counts配列が大きい場合は期間分割を推奨
3. **リレー選択**: 発行先リレーは分析対象と同じが望ましい
4. **タイムゾーン**: すべてUTC基準

### 参考

- NIP-01: Basic protocol flow description
- NIP-07: window.nostr capability for web browsers
- NIP-33: Parameterized Replaceable Events

